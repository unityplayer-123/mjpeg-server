<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>MJPEG Viewer</title>
</head>

<body style="margin:0; background:black;">
<img id="stream" src="/screen" style="width:100vw; height:100vh; object-fit:contain;">

<canvas id="canvas" style="display:none;"></canvas>

<script>
const img = document.getElementById("stream");
const canvas = document.getElementById("canvas");
const ctx = canvas.getContext("2d");

let saving = false;

// ===== 保存タイミング制御 =====

// 5秒後に保存開始
setTimeout(() => {
    saving = true;
    console.log("SAVE START");

    // 10秒後に保存終了
    setTimeout(() => {
        saving = false;
        console.log("SAVE END");
    }, 10000);

}, 5000);

// ===== フレーム取得ループ =====
async function captureLoop() {
    if (saving && img.complete) {

        // ① Server に最新フレームIDを問い合わせ
        const res = await fetch("/latest-id");
        const data = await res.json();
        const frameId = data.frameId;

        if (frameId) {
            canvas.width = img.naturalWidth;
            canvas.height = img.naturalHeight;
            ctx.drawImage(img, 0, 0);

            canvas.toBlob(blob => {
                // ② Unity と同一IDで保存
                fetch(`/save-frame?id=${frameId}`, {
                    method: "POST",
                    headers: { "Content-Type": "image/png" },
                    body: blob
                });
            }, "image/png");
        }
    }

    requestAnimationFrame(captureLoop);
}

captureLoop();
</script>
</body>
</html>
